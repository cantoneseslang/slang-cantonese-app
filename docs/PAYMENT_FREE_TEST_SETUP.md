# 支払いが発生しないテストモード設定ガイド

## 概要

実際の決済が発生しない状態でテストするための設定方法です。Stripeのテストモードを使用することで、実際のクレジットカード決済は発生しません。

## 重要なポイント

✅ **Stripeのテストモードでは実際の決済は発生しません**  
✅ **テスト用カード番号を使用しても実際の請求はされません**  
✅ **テストモードと本番モードは完全に分離されています**

## 設定手順

### 1. Stripeダッシュボードでテストモードに切り替え

1. [Stripeダッシュボード](https://dashboard.stripe.com/)にログイン
2. 右上の「**テストモード**」トグルをONにする（または「**本番モード**」から「**テストモード**」に切り替え）

### 2. テスト用APIキーを取得

1. Stripeダッシュボードの「**開発者**」→「**APIキー**」を開く
2. **テストモード**の「シークレットキー」をコピー（`sk_test_...`で始まる）

### 3. Vercelの環境変数を設定

Vercelダッシュボードで以下の環境変数を設定：

**Key**: `STRIPE_SECRET_KEY`  
**Value**: `sk_test_...`（テストモードのシークレットキー）

**設定手順**:
1. Vercelダッシュボード → プロジェクト → Settings → Environment Variables
2. `STRIPE_SECRET_KEY`を検索または新規追加
3. Valueにテストモードのシークレットキーを貼り付け（`sk_test_...`で始まる）
4. Environment: Production, Preview, Development すべてに適用
5. 「Save」をクリック

**注意**: 
- シークレットキーは機密情報のため、コードやドキュメントに直接記載しないでください
- 公開可能キー（`pk_test_...`）は現在の実装では使用していませんが、将来的にフロントエンドで使用する場合は`NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`として設定できます

### 4. テスト用Webhookシークレットを設定

1. Stripeダッシュボードの「**開発者**」→「**Webhook**」を開く
2. 「**エンドポイントを追加**」をクリック
3. エンドポイントURL: `https://your-domain.vercel.app/api/webhooks/stripe`
4. イベントを選択:
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
5. 「**エンドポイントを追加**」をクリック
6. 「**署名シークレットを表示**」をクリックしてシークレットをコピー（`whsec_test_...`で始まる）

**Vercelの環境変数に設定**:
- **Key**: `STRIPE_WEBHOOK_SECRET`
- **Value**: `whsec_test_...`（テストモードのWebhookシークレット）

## テスト用カード番号

Stripeのテストモードでは、以下のテスト用カード番号を使用できます。**実際の決済は発生しません**。

### 成功するカード（推奨）
- **カード番号**: `4242 4242 4242 4242`
- **有効期限**: 任意の未来の日付（例: `12/34`）
- **CVC**: 任意の3桁の数字（例: `123`）
- **郵便番号**: 任意の5桁の数字（例: `12345`）

### その他のテストカード
- **3Dセキュア認証が必要**: `4000 0025 0000 3155`
- **認証失敗**: `4000 0000 0000 0002`
- **カード不足**: `4000 0000 0000 9995`
- **処理エラー**: `4000 0000 0000 0119`

詳細は[Stripe Testing](https://stripe.com/docs/testing)を参照してください。

## テスト手順

1. **環境変数の確認**
   - `STRIPE_SECRET_KEY`が`sk_test_`で始まっているか確認
   - `STRIPE_WEBHOOK_SECRET`が`whsec_test_`で始まっているか確認

2. **決済テスト**
   - アプリでプランを選択して決済フローを開始
   - Stripe Checkoutページでテスト用カード番号（`4242 4242 4242 4242`）を入力
   - 決済が完了すると、`/payment/success`ページにリダイレクトされます

3. **確認**
   - Stripeダッシュボードの「**支払い**」セクションで、テストモードの決済が記録されていることを確認
   - 実際のクレジットカードには請求されていないことを確認
   - Supabaseダッシュボードで、ユーザーの`membership_type`が更新されていることを確認

## テストモードの確認方法

### 1. Stripeダッシュボードで確認
- 右上に「**テストモード**」と表示されていることを確認
- 「支払い」セクションにテスト決済が記録されていることを確認

### 2. コードで確認
- `STRIPE_SECRET_KEY`が`sk_test_`で始まっている場合、自動的にテストモードとして判定されます

### 3. 決済履歴で確認
- Stripeダッシュボードの「支払い」セクションで、テスト決済には「**テストモード**」のラベルが表示されます

## 本番モードへの切り替え

テストが完了したら、本番環境にデプロイする際は以下の環境変数を本番用の値に変更してください：

1. **Stripeダッシュボードで本番モードに切り替え**
   - 右上の「**テストモード**」から「**本番モード**」に切り替え

2. **本番用APIキーを取得**
   - 「開発者」→「APIキー」で、本番モードのシークレットキーをコピー（`sk_live_...`で始まる）

3. **Vercelの環境変数を更新**
   - `STRIPE_SECRET_KEY`: `sk_live_...`（本番用のAPIキー）
   - `STRIPE_WEBHOOK_SECRET`: `whsec_...`（本番用のWebhookシークレット）

## よくある質問

### Q: テストモードで決済しても実際に請求されますか？
A: **いいえ、請求されません**。テストモードでは実際の決済は発生しません。

### Q: テストモードと本番モードのデータは共有されますか？
A: **いいえ、完全に分離されています**。テストモードのデータは本番モードには影響しません。

### Q: テスト用カード番号で実際の決済が発生しますか？
A: **いいえ、発生しません**。テスト用カード番号はテストモードでのみ使用でき、実際の決済には使用できません。

### Q: テスト期間中はどのモードを使用すべきですか？
A: **テストモードを使用してください**。実際の決済が発生しないため、安全にテストできます。

## トラブルシューティング

### テストモードで決済できない場合

1. `STRIPE_SECRET_KEY`が`sk_test_`で始まっているか確認
2. StripeダッシュボードでテストモードがONになっているか確認
3. テスト用カード番号が正しく入力されているか確認

### Webhookが動作しない場合

1. `STRIPE_WEBHOOK_SECRET`が`whsec_test_`で始まっているか確認
2. StripeダッシュボードでWebhookエンドポイントが正しく設定されているか確認
3. Vercelのログでエラーを確認

